<html>
    <head>
        <title>
        </title>
        <script>

            function degreesToRadians(degrees) {
                return degrees * Math.PI / 180;
            }

            function distanceInKmBetweenEarthCoordinates(lat1, lon1, lat2, lon2) {
                var earthRadiusKm = 6371;

                var dLat = degreesToRadians(lat2-lat1);
                var dLon = degreesToRadians(lon2-lon1);

                lat1 = degreesToRadians(lat1);
                lat2 = degreesToRadians(lat2);

                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                return earthRadiusKm * c;
            }


            (async function(){
                const URL = 'https://filebase.xyz/pbatm/';

                let ATMs = await fetch(URL);

                ATMs = await ATMs.json();

                console.log(ATMs);

                globalThis.navigator.geolocation.getCurrentPosition(function(userPosition){
                    let user_latitude = userPosition.coords.latitude;
                    let user_longitude = userPosition.coords.longitude;  

                    let distances = []

                    for(let atm of ATMs.devices){

                            let dist = distanceInKmBetweenEarthCoordinates(user_latitude,user_longitude, atm.longitude, atm.latitude);

                            atm.distance = dist;

                    }
                    
                    console.log(ATMs.devices); 

                    ATMs.devices.sort(function(a, b){
                        if (a.distance > b.distance) {
                            return 1;
                        }
                        if (a.distance < b.distance) {
                            return -1;
                        }
                        // a должно быть равным b
                        return 0;
                    });

                    for(let atm of ATMs.devices){
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,улица ','');
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,шоссе ','');                          
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,переулок ','');
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,проспект ','');
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,площадь ','');
                            atm.fullAddressRu = atm.fullAddressRu.replace('Украина,область Днепропетровская,город Днепр,поселок ','');
                    }
                    console.log(ATMs.devices); 

                    for(i=0;i<=4;i++){
                        document.write(`Банкомат на улице ${ATMs.devices[i].fullAddressRu} находится в ${Math.trunc(ATMs.devices[i].distance * 1000)} метрах от вас!<>`)
                    }

                });


            })();


        </script>
    </head>
    <body>
    </body>
</html>
